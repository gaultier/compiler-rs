<!DOCTYPE html>
<html>
  <body>
  </body>
  <script>
function JsStringToUtf8Bytes(str) {
  const encoder = new TextEncoder();
  return encoder.encode(str);
}

function Utf8BytesToJsString(bytes) {
    const decoder = new TextDecoder('utf-8');
    return decoder.decode(bytes);
}


async function loadWasm() {
    const memory = new WebAssembly.Memory({ initial: 256, maximum: 256 });

//    const importsObject = createImports(memory);

    try {
        const result = await WebAssembly.instantiateStreaming(
            fetch("target/wasm32-unknown-unknown/debug/compiler_rs_lib.wasm"),
            //importsObject // Provide the required imports (host functions, memory)
        );

        // Extract the exports, which are the C functions marked with __attribute__((export_name))
        const exports = result.instance.exports;
        const memory = result.instance.exports.memory;

        console.log("WebAssembly module loaded and instantiated successfully.", exports);

        if (exports.lex) {
            console.log("Calling WASM exported function 'lex'...");
            let input_js = " 123 456 ";
            let input_bytes = JsStringToUtf8Bytes(input_js);
            const input_length = input_bytes.length;
            console.log(input_length);
            const input_ptr = exports.alloc_u8(input_length)
            const wasm_heap = new Uint8Array(memory.buffer);
            wasm_heap.set(input_bytes, input_ptr); // memcpy.

            let out_ptr = 0;
            let out_len = 0;
            const res = exports.lex(input_ptr, input_length); 
            const res_ptr = (res >> 32n);
            const res_len = (res & 0xffffffffn);
            console.log(res,res_ptr,res_len);

            const res_slice = new Uint8Array(wasm_heap, res_ptr, res_len);
            const res_str = Utf8BytesToJsString(res_slice);
            console.log(res_str);
        }
    } catch (error) {
        console.error("Error loading or running WASM:", error);
    }
}

// Start the loading process
loadWasm();
  </script>
</html>
